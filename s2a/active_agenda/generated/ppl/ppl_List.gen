<?php
/**
 * Template file for generated files (alt. a generated file)
 *
 * PHP version 5
 *
 *
 * LICENSE NOTE:
 *
 * Unless explicitly acquired and licensed from Licensor under another license, the
 * contents of this file are subject to the Reciprocal Public License ("RPL")
 * Version 1.5, or subsequent versions as allowed by the RPL, and You may not copy
 * or use this file in either source code or executable form, except in compliance
 * with the terms and conditions of the RPL. You may obtain a copy of the RPL from
 * Active Agenda Inc. at http://www.activeagenda.net/license.
 *
 * All software distributed under the RPL is provided strictly on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, AND LICENSOR HEREBY
 * DISCLAIMS ALL SUCH WARRANTIES, INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT, OR
 * NON-INFRINGEMENT. See the RPL for specific language governing rights and
 * limitations under the RPL.
 *
 * @author         Mattias Thorslund <mthorslund@activeagenda.net>
 * @copyright      2003-2009 Active Agenda Inc.
 * @license        http://www.activeagenda.net/license  RPL 1.5
 * @version        SVN: $Revision: 1548 $
 * @last-modified  SVN: $Date: 2009-03-05 16:27:47 +0100 (Cz, 05 mar 2009) $
 */

    //check if user has permission to view or edit record
    $allowEdit = $User->CheckListScreenPermission();

    $pageTitle = gettext("People");
    $screenPhrase = gettext("List");

    //remove search filter if user requested it
    if(isset($_GET['clear']) && '1' == $_GET['clear']){
        unset($_SESSION['Search_'.$ModuleID]);
    } 

    $expected_params = array('mdl', 'sr', 'ob', 'pp');

    //clean up query string
    foreach($qsArgs as $qsField => $qsVal){
        if(!in_array($qsField, $expected_params)){
            unset($qsArgs[$qsField]);
        }
    }
    $qs = MakeQS($qsArgs);

    $tabsQS = $qs; //legacy or needed?
    $sQS = $qs;    //legacy or needed?

    $linked = array_keys($linkFields);

    $tabs['List'] = Array('', gettext("List"), 'self');

    if ($allowEdit){
        $tabs['New'] = array("edit.php?mdl=ppl&amp;scr=Form", gettext("Add New|Add a new Person"));$tabs['Search'] = array("search.php?mdl=ppl", gettext("Search|Search people"));$tabs['Charts'] = array("charts.php?mdl=ppl", gettext("Charts"));$tabs['DataCollection'] = array("dataCollectionForm.php?mdl=ppl", gettext("Blank Form"), 'download');
    } else {
        $tabs['New'] = array("", gettext("No Add New|You cannot add a new Person because you don't have permission"), 'disabled');$tabs['Search'] = array("search.php?mdl=ppl", gettext("Search|Search people"));$tabs['Charts'] = array("charts.php?mdl=ppl", gettext("Charts"));$tabs['DataCollection'] = array("dataCollectionForm.php?mdl=ppl", gettext("Blank Form"), 'download');
    }


    //phrases for table headers, in field order
    $headers = array(
   'PersonID' => gettext("Record ID"),
   'LastName' => gettext("Last Name"),
   'FirstName' => gettext("First Name"),
   'DisplayName' => gettext("Display Name"),
   'WorkPhone' => gettext("Work Phone"),
   'WorkEmail' => gettext("Work Email"),
   'Organization' => gettext("Organization")
   );


    //table column alignment values
    $fieldAlign = array(
'PersonID' => 'center',
'LastName' =>  'left',
'FirstName' =>  'left',
'DisplayName' =>  'left',
'WorkPhone' =>  'left',
'WorkEmail' =>  'left',
'Organization' =>  'left'
);


    //table column data types - to format values (Yes/No, date, number, etc.)
    $fieldTypes = array(
'PersonID' => 'int',
'LastName' => 'varchar(50)',
'FirstName' => 'varchar(50)',
'DisplayName' => 'varchar(50)',
'WorkPhone' => 'varchar(50)',
'WorkEmail' => 'varchar(128)',
'Organization' => 'varchar(128)'
);


    $fieldFormats = array(

);


    $linkFields = array(
   'WorkEmail' => "WorkEmail"
   );


    $useBestPractices = false; //default value
    /**useBestPractices**/

    $defaultOrderBys = unserialize('a:1:{s:8:"LastName";N;}');

    $listFilterSQL = $User->getListFilterSQL($ModuleID);

    $nColumns = count($headers);

    $offset = 0;
    if(!empty($_GET['o'])){
        $offset = intval($_GET['o']);
    }

    $clearSearch = false;
    if(isset($_GET['clear']) && '1' == $_GET['clear']){
        $clearSearch = true;
    }

    $filterByURL = false;
    if(isset($_GET['filter']) && '1' == $_GET['filter']){
        $filterByURL = true;
        $clearSearch = true;
    }

    if(!$clearSearch && isset($_SESSION['Search_'.$ModuleID])){
        $search = $_SESSION['Search_'.$ModuleID];
    } else {
        //create an empty Search object
        $search = GetNewSearch($ModuleID);

        if(!$clearSearch && !$filterByURL){
            $search->loadUserDefault($User->PersonID);
        }
        if($filterByURL){
            $search->loadURLFilter();
        }
        $_SESSION['Search_'.$ModuleID] = $search;
    }

    $search = $_SESSION['Search_'.$ModuleID];
    $perPage = 10;
    if(!empty($_GET['pp'])){
        $perPage = intval($_GET['pp']);
    }

    $listData =& new ListData($ModuleID, $search->getListSQL(null, true), $perPage, $fieldTypes, true, null, $fieldFormats);
    $nRows = $listData->getCount();
    if(0 == $nRows){
        $content = gettext("The request returned no data. Please try a different search.").'<br /><br />';
    } else {
        $startRow = 0;
        if(!empty($_GET['sr'])){
            $startRow = intval($_GET['sr']);
        }
        $renderer =& new ListRenderer(
            $ModuleID,
            $listData,
            $headers,
            'view.php?',
            'list.php?',
            $fieldAlign,
            'list',
            $linkFields
        );
        $renderer->useBestPractices = $useBestPractices;
        $content = $renderer->render($startRow, $defaultOrderBys);
    }

    //return just the table HTML if this is an AJAX-style call
    if(isset($_GET['rpc']) && 1 == $_GET['rpc']){
        die($content);
    }

    //add the link to let user clear the filter
    if(is_object($search)){
        if(isset($_GET['defaultFilter']) && '1' == $_GET['defaultFilter']){
            $search->saveUserDefault($User->PersonID);
        }

        $content .= "<br />\n";
        $content .= '<div class="searchFilter"><b>'.gettext("Search Filter Conditions").':</b><br />'."\n";
        $content .= $search->getPhrases();

        if($search->hasConditions()){

            $content .= "<br />\n<br />\n";
            if($search->isUserDefault){
                $content .= gettext("This is your default search for this module.");
            } else {
                $defaultSearchLink = '<a href="list.php?defaultFilter=1&amp;'.$sQS.'">'.gettext("Make this my Default Filter for this module").'</a>';
                $content .= $defaultSearchLink;
            }

            $content .= "<br />\n";
            $clearSearchLink = '<a href="list.php?clear=1&amp;'.$sQS.'">'.gettext("Clear Search Filter (removing conditions)").'</a>';
            $content .= $clearSearchLink;
        }

        $content .= "<br />\n<br />\n<b>".gettext("Download Data").":</b><br />\n";

        $content .= '<div class="dl_icon">';
        $content .= '<a href="dataDownload.php?type=1&amp;'.$sQS.'"'.$downloadtarget.' title="'.gettext("Download as Comma-separated Values (flat file)").'"><img src="'.$theme_web.'/img/dl-csv.png" /><br />';
        $content .= gettext("CSV");
        $content .= '</a></div>';

        $content .= '<div class="dl_icon">';
        $content .= '<a href="dataDownload.php?type=2&amp;'.$sQS.'"'.$downloadtarget.' title="'.gettext("Download as an XML file").'"><img src="'.$theme_web.'/img/dl-xml.png" /><br />';
        $content .= gettext("XML");
        $content .= '</a></div>';

        $content .= '<div class="dl_icon">';
        $content .= '<a href="dataDownload.php?type=3&amp;'.$sQS.'"'.$downloadtarget.' title="'.gettext("Download as a spreadsheet file").'"><img src="'.$theme_web.'/img/dl-spreadsheet.png"  /><br />';
        $content .= gettext("Spreadsheet");
        $content .= '</a></div>';
        
        $content .= "\n";
        //custom code
        /**CUSTOM_CODE|accReassign**/

        $content .= '<div class="dl_icon_clear">&nbsp;</div>';
        $content .= "</div><br />\n";
    }
?>
